<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
        <title>臭臭平台</title>
        <link rel="icon" th:href="@{/img/cc.png}" />
        <link rel="stylesheet" th:href="@{/layui/css/layui.css}" media="all" />
        <style>
            .layui-form-label {
                width: 120px;
            }
        </style>
    </head>

    <body style="padding: 15px;">
        <form class="layui-form" th:object="${orderBasic}">
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                <legend>客户信息</legend>
            </fieldset>
            <input type="hidden" name="id" th:value="*{id}" readonly>

            <div class="layui-form-item">
                <label class="layui-form-label">客户姓名</label>
                <div class="layui-input-inline">
                    <input type="text" name="name" th:value="*{name}" lay-verify="required" autocomplete="off" placeholder="请输入客户姓名" class="layui-input">
                </div>

                <label class="layui-form-label">手机号码</label>
                <div class="layui-input-inline">
                    <input type="tel" name="mobile" th:value="*{mobile}" autocomplete="off" placeholder="请输入手机号码" class="layui-input">
                </div>

                <label class="layui-form-label">微信号</label>
                <div class="layui-input-inline">
                    <input type="text" name="wechat" th:value="*{wechat}" autocomplete="off" placeholder="请输入微信号" class="layui-input">
                </div>

                <label class="layui-form-label">性别</label>
                <div class="layui-input-inline">
                    <input type="radio" name="sex" value="0" title="女" th:checked="*{sex == null or sex == 0}">
                    <input type="radio" name="sex" value="1" title="男" th:checked="*{sex == 1}">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">客户情况</label>
                <div class="layui-input-inline">
                    <select name="customerState" lay-verify="required">
                        <option value=""></option>
                        <option value="1" th:selected="*{customerState == 1}">产值可签单</option>
                        <option value="2" th:selected="*{customerState == 2}">产值已出</option>
                        <option value="3" th:selected="*{customerState == 3}">定金可转换</option>
                        <option value="4" th:selected="*{customerState == 4}">跟进中</option>
                        <option value="5" th:selected="*{customerState == 5}">无效</option>
                        <option value="6" th:selected="*{customerState == 6}">已退单</option>
                        <option value="7" th:selected="*{customerState == 7}">已完结</option>
                        <option value="8" th:selected="*{customerState == 8}">意向可签单</option>
                    </select>
                </div>

                <label class="layui-form-label">派单日期</label>
                <div class="layui-input-inline">
                    <input type="text" id="talkTime" name="talkTime" th:value="*{talkTime}" lay-verify="required" readonly placeholder="派单日期" autocomplete="off" class="layui-input">
                </div>

                <label class="layui-form-label">派单序号</label>
                <div class="layui-input-inline">
                    <input type="number" name="talkNo" th:value="*{talkNo}" lay-verify="required" placeholder="派单序号" autocomplete="off" class="layui-input">
                </div>
            </div>

            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 40px;">
                <legend>协议信息</legend>
            </fieldset>

            <div class="layui-form-item">
                <label class="layui-form-label">协议类型</label>
                <div class="layui-input-inline">
                    <select name="treatyType">
                        <option value=""></option>
                        <option value="1" th:selected="*{treatyType == 1}">产品代购</option>
                        <option value="2" th:selected="*{treatyType == 2}">产品代购/合作</option>
                        <option value="3" th:selected="*{treatyType == 3}">产品合作</option>
                        <option value="4" th:selected="*{treatyType == 4}">定金协议</option>
                        <option value="5" th:selected="*{treatyType == 5}">设计协议</option>
                    </select>
                </div>

                <label class="layui-form-label">协议详情</label>
                <div class="layui-input-inline">
                    <select name="treatyDetail">
                        <option value=""></option>
                        <option value="1" th:selected="*{treatyDetail == 1}">可退</option>
                        <option value="2" th:selected="*{treatyDetail == 2}">不可退</option>
                        <option value="3" th:selected="*{treatyDetail == 3}">纯设计</option>
                        <option value="4" th:selected="*{treatyDetail == 4}">全案设计</option>
                        <option value="5" th:selected="*{treatyDetail == 5}">返点</option>
                        <option value="6" th:selected="*{treatyDetail == 6}">全款</option>
                        <option value="7" th:selected="*{treatyDetail == 7}">全款/返点</option>
                    </select>
                </div>

                <label class="layui-form-label">设计签订日期</label>
                <div class="layui-input-inline">
                    <input type="text" id="designTime" name="designTime" th:value="*{designTime}" readonly placeholder="设计签订日期" autocomplete="off" class="layui-input">
                </div>

                <label class="layui-form-label">产值签订日期</label>
                <div class="layui-input-inline">
                    <input type="text" id="outputTime" name="outputTime" th:value="*{outputTime}" readonly placeholder="产值签订日期" autocomplete="off" class="layui-input">
                </div>
            </div>

            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 40px;">
                <legend>楼盘信息</legend>
            </fieldset>

            <div class="layui-form-item">
                <label class="layui-form-label">精装</label>
                <div class="layui-input-inline">
                    <input type="radio" name="hardcover" value="0" title="否" th:checked="*{hardcover == null or hardcover == 0}">
                    <input type="radio" name="hardcover" value="1" title="是" th:checked="*{hardcover == 1}">
                </div>

                <label class="layui-form-label">楼盘名称</label>
                <div class="layui-input-inline">
                    <input type="text" name="saleName" th:value="*{saleName}" autocomplete="off" placeholder="请输入楼盘名称" class="layui-input">
                </div>

                <label class="layui-form-label">房号</label>
                <div class="layui-input-inline">
                    <input type="text" name="saleNo" th:value="*{saleNo}" autocomplete="off" placeholder="请输入房号" class="layui-input">
                </div>

                <label class="layui-form-label">面积</label>
                <div class="layui-input-inline">
                    <input type="number" name="saleArea" th:value="*{saleArea}" autocomplete="off" placeholder="请输入面积" class="layui-input">
                </div>
                <div class="layui-form-mid layui-word-aux">㎡</div>
            </div>

            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 40px;">
                <legend>沟通信息</legend>
            </fieldset>

            <div class="layui-form-item">
                <label class="layui-form-label">常驻人口</label>
                <div class="layui-input-inline">
                    <input type="number" name="residentNum" th:value="*{residentNum}" autocomplete="off" placeholder="请输入常驻人口" class="layui-input">
                </div>

                <label class="layui-form-label">洽谈地点</label>
                <div class="layui-input-inline">
                    <input type="text" name="address" th:value="*{address}" autocomplete="off" placeholder="请输入洽谈地点" class="layui-input">
                </div>

                <div class="layui-inline">
                    <label class="layui-form-label">费用预算</label>
                    <div class="layui-input-inline" style="width: 190px;">
                        <input type="number" name="salePriceMin" th:value="*{salePriceMin}" placeholder="￥" autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-form-mid">-</div>
                    <div class="layui-input-inline" style="width: 190px;">
                        <input type="number" name="salePriceMax" th:value="*{salePriceMax}" placeholder="￥" autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-form-mid layui-word-aux">万元</div>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">意向风格</label>
                <div class="layui-input-inline" style="width: 540px">
                    <textarea name="purpose" th:text="*{purpose}" placeholder="请输入意向风格" class="layui-textarea"></textarea>
                </div>

                <label class="layui-form-label">特殊需求</label>
                <div class="layui-input-inline" style="width: 540px">
                    <textarea name="purpose" th:text="*{purpose}" placeholder="请输入特殊需求" class="layui-textarea"></textarea>
                </div>
            </div>

            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 40px;">
                <legend>项目人员</legend>
            </fieldset>

            <div class="layui-form-item">
                <label class="layui-form-label">渠道</label>
                <div class="layui-input-inline">
                    <input type="text" name="channel" th:value="*{channel}" autocomplete="off" placeholder="请输入渠道" class="layui-input">
                </div>

                <label class="layui-form-label">推荐人</label>
                <div class="layui-input-inline">
                    <div id="recommend"></div>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">营销中心</label>
                <div class="layui-input-inline">
                    <div id="marketDept"></div>
                </div>

                <label class="layui-form-label">营销专员</label>
                <div class="layui-input-inline">
                    <div id="marketEmp"></div>
                </div>

                <label class="layui-form-label">营销负责人</label>
                <div class="layui-input-inline">
                    <div id="marketBelong"></div>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">设计中心</label>
                <div class="layui-input-inline">
                    <div id="designDept"></div>
                </div>

                <label class="layui-form-label">客户经理</label>
                <div class="layui-input-inline">
                    <div id="manager"></div>
                </div>

                <label class="layui-form-label">设计师</label>
                <div class="layui-input-inline">
                    <div id="designEmp"></div>
                </div>

                <label class="layui-form-label">设计负责人</label>
                <div class="layui-input-inline">
                    <div id="designBelong"></div>
                </div>
            </div>

            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 40px;">
                <legend>备注</legend>
            </fieldset>

            <div class="layui-form-item">
                <label class="layui-form-label">详情</label>
                <div class="layui-input-inline" style="width: 540px;">
                    <textarea name="remarks" th:text="*{remarks}" placeholder="请输入备注" class="layui-textarea"></textarea>
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button type="submit" class="layui-btn" lay-submit="" lay-filter="submit">提交</button>
                    <button lay-filter="close" class="layui-btn layui-btn-primary">取消</button>
                </div>
            </div>
        </form>
    </body>

    <!--[if lt IE 9]>
    <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
    <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script th:src="@{/layui/layui.js}"></script>
    <script th:src="@{/js/tree/xm-select.js}"></script>

    <script th:inline="javascript">
        const id = [[ ${orderBasic.id} ]];
        const recommend = [[ ${orderBasic.recommend} ]];
        const marketEmp = [[ ${orderBasic.marketEmp} ]];
        const marketBelong = [[ ${orderBasic.marketBelong} ]];
        const manager = [[ ${orderBasic.manager} ]];
        const designEmp = [[ ${orderBasic.designEmp} ]];
        const designBelong = [[ ${orderBasic.designBelong} ]];
        const marketDept = [[ ${orderBasic.marketDept} ]];
        const designDept = [[ ${orderBasic.designDept} ]];
    </script>

    <script>
        layui.extend({
            request: '/js/index/request'
        }).use(['form', 'layer', 'jquery', 'request', 'laydate'], function () {
            const form = layui.form;
            const layer = layui.layer;
            const $ = layui.jquery;
            const request = layui.request;
            const laydate = layui.laydate;

            laydate.render({
                elem: '#talkTime',
                calendar: true
            });

            laydate.render({
                elem: '#designTime',
                calendar: true
            });

            laydate.render({
                elem: '#outputTime',
                calendar: true
            });

            let isOK = 0;
            // 推荐人
            const recommends = [];
            if (recommend) {
                recommends.push(recommend);
            }
            renderUser('recommend', recommends, true, 0);
            // 客户经理
            let managers = [];
            if (manager) {
                managers = manager.split(',');
            }
            renderUser('manager', managers, false, 0);
            // 设计师
            let designEmps = [];
            if (designEmp) {
                designEmps = designEmp.split(',');
            }
            renderUser('designEmp', designEmps, false, 0);

            const marketEmps = [];
            const marketBelongs = [];
            const designBelongs = []
            initRender();

            function initRender() {
                // 营销专员
                if (marketDept) {
                    marketEmps.push(marketEmp);
                }
                // 营销负责人
                if (marketDept) {
                    marketBelongs.push(marketBelong);
                }
                // 设计负责人
                if (designDept) {
                    designBelongs.push(designBelong);
                }

                renderDeptUser('marketEmp', true, marketDept, marketEmps);
                renderDeptUser('marketBelong', true, marketDept, marketBelongs);
                renderDeptUser('designBelong', true, designDept, designBelongs);
            }

            $('button[lay-filter="close"]').on('click', function () {
                const index = parent.layer.getFrameIndex(window.name);
                parent.layer.close(index);
            });

            function renderUser(elem, initValue, radio, where) {
                request.postJson({
                    url: '/orderBasic/allUser',
                    async: false,
                    data: {type: where, ids: initValue},
                    callback: function (res) {
                        layer.closeAll('loading');
                        if (res.status !== 200) {
                            layer.msg(res.message, {icon: 5, anim: 6});
                            return false;
                        }

                        renderDeptUserXm(res.data.records, elem, radio, where, initValue);
                    }
                });
            }

            request.post({
                url: '/orderBasic/deptTree',
                async: false,
                callback: function (res) {
                    layer.closeAll('loading');
                    if (res.status !== 200) {
                        layer.msg(res.message, {icon: 5, anim: 6});
                        return false;
                    }

                    const marketDepts = [];
                    if (marketDept) {
                        marketDepts.push(marketDept);
                    }
                    xmRender('#marketDept', res.data, marketDepts, 'marketDept', '请选择营销中心', function (data) {
                        if (data.isAdd) {
                            isOK = 0;
                            const onRes = data.change.slice(0, 1);
                            renderDeptUser('marketEmp', true, onRes[0].id, marketEmps);
                            renderDeptUser('marketBelong', true, onRes[0].id, marketBelongs);
                            return onRes;
                        } else {
                            isOK = 1;
                            renderDeptUser('marketEmp', true, '', marketEmps);
                            renderDeptUser('marketBelong', true, '', marketBelongs);
                        }
                    });

                    const designDepts = [];
                    if (designDept) {
                        designDepts.push(designDept);
                    }
                    xmRender('#designDept', res.data, designDepts, 'designDept', '请选择设计中心', function (data) {
                        if (data.isAdd) {
                            isOK = 0;
                            const onRes = data.change.slice(0, 1);
                            renderDeptUser('designBelong', true, onRes[0].id, designBelongs);
                            return onRes;
                        } else {
                            isOK = 1;
                            renderDeptUser('designBelong', true, '', designBelongs);
                        }
                    });
                }
            });

            function xmRender(el, data, initValue, nodeName, tips, on) {
                xmSelect.render({
                    el: el,
                    data: data,
                    name: nodeName,
                    initValue: initValue,
                    prop: {
                        name: 'name',
                        value: 'id'
                    },
                    tips: tips,
                    empty: '呀, 没有数据呢',
                    clickClose: true,
                    model: {label: {type: 'text'}},
                    tree: {
                        show: true,
                        strict: false,
                        expandedKeys: initValue
                    },
                    on: on
                });
            }

            function renderDeptUser(elem, radio, where, initValue) {
                if (isOK) {
                    renderDeptUserXm([], elem, radio, where, initValue);
                    return false;
                }

                request.post({
                    url: '/orderBasic/deptUser',
                    async: false,
                    data: {deptId: where},
                    callback: function (res) {
                        layer.closeAll('loading');
                        if (res.status !== 200) {
                            layer.msg(res.message, {icon: 5, anim: 6});
                            return false;
                        }

                        renderDeptUserXm(res.data, elem, radio, where, initValue);
                    }
                });
            }

            function renderDeptUserXm(data, elem, radio, where, initValue) {
                xmSelect.render({
                    el: '#' + elem,
                    name: elem,
                    filterable: true,
                    searchTips: '支出模糊查询',
                    paging: true,
                    pageEmptyShow: false,
                    pageSize: 10,
                    radio: radio,
                    autoRow: !radio,
                    clickClose: radio,
                    initValue: initValue,
                    prop: {
                        name: 'name',
                        value: 'id'
                    },
                    data: data
                });
            }

            form.on('submit(submit)', function (data) {
                const id = data.field.id;
                const method = id == null || id == '' ? 'POST' : "PUT";
                const message = id == null || id == '' ? '新增成功' : "修改成功";

                request.jsonQs({
                    url: '/orderBasic',
                    type: method,
                    data: data.field,
                    callback: function (res) {
                        layer.closeAll('loading');
                        if (res.status !== 200) {
                            layer.msg(res.message, {icon: 5, anim: 6});
                            return false;
                        }

                        layer.msg(message, {
                            icon: 6,
                            time: 500,
                            end: function () {
                                const index = parent.layer.getFrameIndex(window.name);
                                parent.layer.close(index);
                                parent.refresh.reloadSearch();
                            }
                        });
                    }
                });

                return false;
            });
        });
    </script>
</html>
